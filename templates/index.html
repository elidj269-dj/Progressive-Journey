<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Progressive Journey</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --warm: #00d4ff; --build: #00ff40; --mid: #ffaa00;
            --peak: #ff0040; --driving: #ccff00; --closing: #9d00ff;
        }
        body { background-color: #010b13; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; text-align: center; }
        
        .header-img { 
            width: 100%; height: auto; max-height: 450px; object-fit: contain; 
            border-radius: 15px; border: 2px solid #00f2ff; margin-bottom: 20px;
        }
        
        h1 { color: #00ff8c; text-shadow: 0 0 10px #00ff8c; margin-bottom: 25px; }

        .auth-container {
            background: #001a26; padding: 30px; border-radius: 15px;
            border: 1px solid #00f2ff; margin: 50px auto; max-width: 400px;
        }
        .auth-container h2 { margin-bottom: 20px; color: #00ff8c; }
        .auth-container input {
            width: 100%; box-sizing: border-box; margin-bottom: 15px;
        }
        .btn-auth {
            background: #00ff8c; color: #000; border: none; padding: 10px 20px;
            font-weight: bold; border-radius: 8px; cursor: pointer;
            width: 100%;
        }
        .error-message { color: #ff0040; margin-bottom: 15px; }
        
        .user-status-card {
            background: #001a26;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #00f2ff;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            color: #fff;
            font-size: 1.1em;
        }
        
        .user-info-text { margin: 0; line-height: 1.4; }
        .user-email { color: #00ff8c; font-weight: bold; }
        .user-role { color: #00d4ff; font-weight: bold; }
        .trial-uses-left { color: #ffaa00; font-weight: bold; font-size: 1.2em; }

        .user-actions { display: flex; gap: 10px; margin-top: 0; }

        .btn-secondary-action {
            background: transparent;
            border: 1px solid #00f2ff;
            color: #00f2ff;
            padding: 8px 15px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none; 
            transition: background 0.3s, color 0.3s;
        }

        .btn-secondary-action:hover { background: #00f2ff; color: #010b13; }

        .btn-primary-action {
            background: #00ff8c;
            color: #000;
            border: none;
            padding: 8px 15px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none; 
            transition: background 0.3s, transform 0.2s;
        }

        .btn-primary-action:hover { background: #00e67a; transform: translateY(-1px); }

        .filters { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; }
        .filters button { 
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; 
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .btn-warm { border: 2px solid var(--warm); color: var(--warm); }
        .btn-build { border: 2px solid var(--build); color: var(--build); }
        .btn-mid { border: 2px solid var(--mid); color: var(--mid); }
        .btn-peak { border: 2px solid var(--peak); color: var(--peak); }
        .btn-drive { border: 2px solid var(--driving); color: var(--driving); }
        .btn-close { border: 2px solid var(--closing); color: var(--closing); }

        .search-box { 
            display: flex; gap: 15px; background: #001a26; padding: 20px; 
            border-radius: 12px; border: 1px solid #00f2ff; margin-bottom: 25px;
        }
        input, select { background: #000; color: #fff; border: 1px solid #00f2ff; padding: 12px; border-radius: 8px; flex-grow: 1; }
        .hours-disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-generate { 
            background: #00ff8c; color: #000; border: none; padding: 0 30px; 
            font-weight: bold; border-radius: 8px; cursor: pointer;
        }

        .track-header { 
            display: grid; grid-template-columns: 50px 1fr 80px 80px 120px; 
            padding: 15px; font-weight: bold; color: #00ff8c; border-bottom: 2px solid #003a4d;
            text-align: left;
        }
        .track-list { background: #001a26; border-radius: 12px; margin-top: 20px; border: 1px solid #003a4d; overflow: hidden; }
        .track-item { 
            display: grid; grid-template-columns: 50px 1fr 80px 80px 120px; 
            padding: 15px; border-bottom: 1px solid #003a4d; align-items: center; text-align: left;
        }
        .has-actions { grid-template-columns: 40px 40px 1fr 60px 60px 100px 80px !important; }

        .track-item:last-child { border-bottom: none; }
        .track-item.selectable:hover { background: rgba(0, 255, 140, 0.1); cursor: pointer; }
        
        .col-num { color: #5d7a8c; }
        .col-track { font-weight: bold; }
        .col-bpm { color: #00d4ff; }
        .col-key { color: #00ff8c; font-weight: bold; }
        .energy-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; text-align: center; border: 1px solid; }

        .export-tools { display: flex; justify-content: center; gap: 15px; margin-top: 30px; padding-bottom: 50px; }
        .btn-export { 
            background: transparent; border: 1px solid #00ff8c; color: #00ff8c; 
            padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .btn-export:hover { background: #00ff8c; color: #000; }

        .col-actions button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00ff8c;
            border-radius: 5px;
            cursor: pointer;
            padding: 5px 10px;
            color: #00ff8c;
            font-size: 11px;
            font-weight: bold;
        }
        .col-lock.locked { color: #ff0040; cursor: pointer; } 
        .col-lock { color: #00ff40; cursor: pointer; }

        .payment-options-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .payment-content {
            background: #001a26;
            padding: 40px;
            border-radius: 12px;
            border: 1px solid #00f2ff;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: left;
            position: relative;
        }

        .payment-content h3 { color: #00ff8c; margin-bottom: 15px; }
        .btn-mercadopago {
            background: #00ff8c;
            color: #000;
            border: none;
            padding: 10px 15px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-crypto {
            background: transparent;
            border: 1px solid #00f2ff;
            color: #00f2ff;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .crypto-address {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
            overflow-wrap: break-word;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #ff0040;
            font-size: 30px;
            cursor: pointer;
        }

/* Modal de Compartir */
.share-modal-container {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.share-modal-content {
    background: linear-gradient(135deg, #001a26 0%, #002633 100%);
    padding: 40px;
    border-radius: 15px;
    border: 2px solid #00f2ff;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 242, 255, 0.3);
    text-align: center;
    position: relative;
    animation: slideUp 0.4s ease;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.share-modal-content h3 {
    color: #00ff8c;
    margin-bottom: 10px;
    font-size: 1.5em;
    text-shadow: 0 0 10px #00ff8c;
}

.share-modal-content p {
    color: #00d4ff;
    margin-bottom: 30px;
    font-size: 0.95em;
}

.share-buttons-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.btn-share-social {
    background: rgba(0, 242, 255, 0.1);
    border: 2px solid #00f2ff;
    color: #00f2ff;
    padding: 15px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95em;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-share-social:hover {
    background: #00f2ff;
    color: #010b13;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 242, 255, 0.4);
}

.btn-share-copy {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #00ff8c 0%, #00d4ff 100%);
    color: #000;
    border: none;
    padding: 15px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.05em;
    transition: all 0.3s ease;
}

.btn-share-copy:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 20px rgba(0, 255, 140, 0.5);
}

.share-link-display {
    background: #000;
    border: 1px solid #00f2ff;
    padding: 12px;
    border-radius: 8px;
    margin-top: 20px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #00ff8c;
    word-break: break-all;
    cursor: pointer;
    transition: background 0.3s;
}

.share-link-display:hover {
    background: rgba(0, 255, 140, 0.1);
}

.close-share-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #ff0040;
    font-size: 28px;
    cursor: pointer;
    transition: transform 0.3s;
}

.close-share-btn:hover {
    transform: rotate(90deg);
}

.btn-share-set {
    background: linear-gradient(135deg, #00ff8c 0%, #00d4ff 100%);
    color: #000;
    border: none;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95em;
    transition: all 0.3s ease;
}

.btn-share-set:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 20px rgba(0, 255, 140, 0.5);
}

/* ============================================ */
/* SPOTIFY INTEGRATION STYLES */
/* ============================================ */

.spotify-search-container {
    background: linear-gradient(135deg, #001a26 0%, #002633 100%);
    padding: 25px;
    border-radius: 15px;
    border: 2px solid #1DB954;
    margin-bottom: 25px;
}

.spotify-search-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.spotify-logo {
    font-size: 1.5em;
}

.spotify-search-header h3 {
    color: #1DB954;
    margin: 0;
    text-shadow: 0 0 10px #1DB954;
}

.spotify-search-box {
    display: flex;
    gap: 15px;
    align-items: center;
}

.spotify-search-input {
    flex: 1;
    background: #000;
    color: #fff;
    border: 2px solid #1DB954;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 1em;
}

.spotify-search-input:focus {
    outline: none;
    box-shadow: 0 0 15px rgba(29, 185, 84, 0.5);
}

.btn-spotify-search {
    background: #1DB954;
    color: #000;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-spotify-search:hover {
    background: #1ed760;
    transform: scale(1.05);
    box-shadow: 0 5px 20px rgba(29, 185, 84, 0.5);
}

.spotify-results {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.spotify-track-item {
    display: grid;
    grid-template-columns: 60px 1fr 80px auto;
    gap: 15px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #003a4d;
    border-radius: 8px;
    margin-bottom: 10px;
    align-items: center;
    transition: all 0.3s ease;
}

.spotify-track-item:hover {
    background: rgba(29, 185, 84, 0.1);
    border-color: #1DB954;
    transform: translateX(5px);
}

.spotify-album-art {
    width: 50px;
    height: 50px;
    border-radius: 5px;
    object-fit: cover;
}

.spotify-track-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.spotify-track-name {
    font-weight: bold;
    color: #fff;
}

.spotify-artist-name {
    color: #00d4ff;
    font-size: 0.9em;
}

.spotify-track-meta {
    display: flex;
    gap: 10px;
    align-items: center;
    color: #5d7a8c;
    font-size: 0.85em;
}

.spotify-preview-btn {
    background: transparent;
    border: 2px solid #1DB954;
    color: #1DB954;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.spotify-preview-btn:hover {
    background: #1DB954;
    color: #000;
}

.spotify-preview-btn.playing {
    background: #1DB954;
    color: #000;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.btn-add-spotify-track {
    background: linear-gradient(135deg, #1DB954 0%, #00ff8c 100%);
    color: #000;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-add-spotify-track:hover {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(29, 185, 84, 0.5);
}

.spotify-no-results {
    text-align: center;
    padding: 30px;
    color: #5d7a8c;
}

/* Toggle para mostrar/ocultar Spotify */
.spotify-toggle {
    text-align: center;
    margin-bottom: 20px;
}

.btn-toggle-spotify {
    background: transparent;
    border: 2px solid #1DB954;
    color: #1DB954;
    padding: 10px 25px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-toggle-spotify:hover {
    background: #1DB954;
    color: #000;
}

.btn-toggle-spotify.active {
    background: #1DB954;
    color: #000;
}

/* ============================================ */
/* üéµ PREVIEW MODAL (SPOTIFY + YOUTUBE) */
/* ============================================ */

.preview-modal-container {
    display: none;
    position: fixed;
    z-index: 3000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.preview-modal-content {
    background: linear-gradient(135deg, #001a26 0%, #002633 100%);
    padding: 30px;
    border-radius: 15px;
    border: 2px solid #00f2ff;
    max-width: 800px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 242, 255, 0.5);
    text-align: center;
    position: relative;
    animation: slideUp 0.4s ease;
}

.preview-modal-header {
    margin-bottom: 20px;
}

.preview-modal-header h3 {
    color: #00ff8c;
    margin: 0 0 10px 0;
    font-size: 1.3em;
    text-shadow: 0 0 10px #00ff8c;
}

.preview-modal-header p {
    color: #00d4ff;
    margin: 0;
    font-size: 0.9em;
}

.preview-player-container {
    width: 100%;
    min-height: 200px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.close-preview-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #ff0040;
    font-size: 28px;
    cursor: pointer;
    transition: transform 0.3s;
    z-index: 10;
}

.close-preview-btn:hover {
    transform: rotate(90deg);
}

.btn-preview {
    background: transparent;
    border: 2px solid #00ff8c;
    color: #00ff8c;
    padding: 5px 12px;
    border-radius: 15px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.85em;
    transition: all 0.3s ease;
}

.btn-preview:hover {
    background: #00ff8c;
    color: #000;
}

.btn-preview.loading {
    opacity: 0.5;
    cursor: wait;
}

.btn-preview.loading::before {
    content: '‚è≥ ';
}

/* ============================================ */
/* VISUALIZACIONES: GR√ÅFICO Y KEY WHEEL */
/* ============================================ */

.visualizations {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin: 30px 0;
}

.viz-card {
    background: rgba(0, 26, 38, 0.8);
    padding: 25px;
    border-radius: 15px;
    border: 2px solid #00f2ff;
}

.viz-card h3 {
    color: #00ff8c;
    margin-bottom: 20px;
    text-shadow: 0 0 10px #00ff8c;
}

#energyChart {
    max-height: 350px;
}

/* Key Wheel */
.key-wheel {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
}

.key-button {
    position: absolute;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    transition: all 0.3s;
    color: #fff;
}

.key-button.active {
    background: linear-gradient(135deg, #00ff8c 0%, #00d4ff 100%);
    border-color: #00ff8c;
    transform: scale(1.3);
    box-shadow: 0 0 25px rgba(0, 255, 136, 0.8);
    color: #000;
}

.key-button.used-multiple {
    animation: pulse-key 2s infinite;
}

@keyframes pulse-key {
    0%, 100% { transform: scale(1.3); }
    50% { transform: scale(1.4); }
}

.spotify-inline-player {
    grid-column: 1 / -1;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    margin-top: 10px;
}

.spotify-track-item {
    display: grid;
    grid-template-columns: 60px 1fr 80px auto;
    gap: 15px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #003a4d;
    border-radius: 8px;
    margin-bottom: 10px;
    align-items: center;
    transition: all 0.3s ease;
}

.btn-plan-selector {
    background: rgba(0, 242, 255, 0.1);
    border: 2px solid #00f2ff;
    color: #00f2ff;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    margin: 5px;
    transition: all 0.3s;
}

.btn-plan-selector.active {
    background: #00ff8c;
    color: #000;
    border-color: #00ff8c;
}

.btn-plan-selector:hover {
    transform: scale(1.05);
}

.payment-method {
    margin: 20px 0;
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    border: 1px solid #003a4d;
}

.payment-method h4 {
    color: #00ff8c;
    margin-bottom: 15px;
}
    </style>
</head>
<body>
    <div class="container">
        <img src="{{ url_for('static', filename='dj.jpg') }}" alt="Header Image" class="header-img">
        <h1>Progressive Journey AI Set Generator</h1>
        
        {% if not current_user.is_authenticated %}
        <div class="auth-container">
            <div id="loginForm" style="display: {% if show_signup %}none{% else %}block{% endif %};">
                <h2>Inicio de Sesi√≥n</h2>
                {% with messages = get_flashed_messages() %}
                  {% if messages %}
                    {% for message in messages %}
                      <p class="error-message">{{ message }}</p>
                    {% endfor %}
                  {% endif %}
                {% endwith %}
                <form method="POST" action="{{ url_for('login') }}">
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" placeholder="Contrase√±a" required>
                    <button type="submit" class="btn-auth">Iniciar Sesi√≥n</button>
                </form>
                <p>¬øNo tienes cuenta? <a href="#" onclick="toggleAuthForm('signup')">Reg√≠strate aqu√≠</a>.</p>
            </div>

            <div id="signupForm" style="display: {% if show_signup %}block{% else %}none{% endif %};">
                <h2>Registro</h2>
                <form method="POST" action="{{ url_for('signup') }}">
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" placeholder="Contrase√±a" required>
                    <button type="submit" class="btn-auth">Crear Cuenta</button>
                </form>
                <p>¬øYa tienes cuenta? <a href="#" onclick="toggleAuthForm('login')">Inicia sesi√≥n aqu√≠</a>.</p>
            </div>
        </div>
        {% else %}
        <div class="user-status-card">
            <p class="user-info-text">
                Hola, <span class="user-email">{{ current_user.email }}</span> (Rol: <span class="user-role">{{ current_user.role }}</span>). 
                {% if current_user.role == 'trial' %}
                Te quedan <span class="trial-uses-left">{{ current_user.trial_uses_left }}</span> usos de prueba.
                {% endif %}
            </p>
            <div class="user-actions">
                <a href="{{ url_for('logout') }}" class="btn-secondary-action">Cerrar sesi√≥n</a>
                {% if current_user.role != 'owner' %}
                <a href="#" onclick="showPaymentOptions()" class="btn-primary-action">Mejorar a PRO</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    <div id="paymentOptions" class="payment-options-container" style="display: none;">
    <div class="payment-content">
        <span class="close-btn" onclick="closePaymentModal()">&times;</span>
        <h3>Opciones de Pago PRO</h3>
        
        <!-- Selector de Plan -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="selectPlan('monthly')" id="btnMonthly" class="btn-plan-selector active">
                üí≥ Mensual - AR$ 10.000 / 10 USDT
            </button>
            <button onclick="selectPlan('annual')" id="btnAnnual" class="btn-plan-selector">
                üíé Anual - AR$ 50.000 / 45 USDT
            </button>
        </div>
        
        <div class="payment-methods">
            <!-- MERCADO PAGO -->
            <div class="payment-method">
                <h4>üí≥ Mercado Pago (Argentina)</h4>
                <button onclick="handleMercadoPago()" class="btn-pay btn-mercadopago" id="btnPayMP">Pagar con MercadoPago</button>
                <div id="payment-widget-container"></div>
            </div>
            
            <!-- USDT CRYPTO -->
            <div class="payment-method">
                <h4>‚Çø Cripto (USDT TRC20)</h4>
                <button onclick="showCryptoPayment()" class="btn-pay btn-crypto">Pagar con USDT</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA PAGO CRYPTO -->
<div id="cryptoPaymentModal" class="payment-options-container" style="display: none;">
    <div class="payment-content" style="max-width: 600px;">
        <span class="close-btn" onclick="closeCryptoModal()">&times;</span>
        <h3>Pago con USDT (TRC20)</h3>
        
        <div style="background: #000; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <p style="color: #00ff8c; font-size: 1.1em; margin-bottom: 10px;">
                Monto a pagar: <strong id="cryptoAmount">10 USDT</strong>
            </p>
            <p style="color: #00d4ff; font-size: 0.9em;">Plan: <span id="cryptoPlan">Mensual</span></p>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <p style="color: #fff; margin-bottom: 10px;">Escane√° el QR o copi√° la direcci√≥n:</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=THBPsSN452NJVzzKUkiGnPYPjZerAFPXqk" alt="QR USDT" style="border: 2px solid #00f2ff; border-radius: 10px;">
            <div class="crypto-address" onclick="copyToClipboard('THBPsSN452NJVzzKUkiGnPYPjZerAFPXqk')" style="margin-top: 15px;">
                THBPsSN452NJVzzKUkiGnPYPjZerAFPXqk
            </div>
        </div>
        
        <div style="background: rgba(255, 170, 0, 0.1); border: 1px solid #ffaa00; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #ffaa00; margin: 0; font-size: 0.95em;">
                ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Solo env√≠es USDT por red TRC20 (Tron). Otras redes resultar√°n en p√©rdida de fondos.
            </p>
        </div>
        
        <h4 style="color: #00ff8c; margin-top: 30px;">Subir Comprobante de Pago</h4>
        <form id="cryptoPaymentForm" onsubmit="submitCryptoPayment(event)" style="text-align: left;">
            <label style="color: #00d4ff; display: block; margin-bottom: 5px;">Captura de pantalla del pago:</label>
            <input type="file" id="paymentScreenshot" accept="image/*" required style="margin-bottom: 15px; width: 100%;">
            
            <label style="color: #00d4ff; display: block; margin-bottom: 5px;">TX ID (opcional):</label>
            <input type="text" id="txId" placeholder="ID de transacci√≥n de Binance/Trust Wallet" style="margin-bottom: 20px; width: 100%;">
            
            <button type="submit" class="btn-pay btn-crypto" style="width: 100%;">
                üì§ Enviar Comprobante
            </button>
        </form>
        
        <p style="color: #5d7a8c; font-size: 0.85em; margin-top: 15px; text-align: center;">
            Tu cuenta ser√° activada manualmente en 24hs h√°biles despu√©s de verificar el pago.
        </p>
    </div>
</div>

<!-- ============================================ -->
<!-- üéµ MODAL DE PREVIEW (SPOTIFY + YOUTUBE) -->
<!-- ============================================ -->
<div id="previewModal" class="preview-modal-container">
    <div class="preview-modal-content">
        <span class="close-preview-btn" onclick="closePreviewModal()">&times;</span>
        
        <div class="preview-modal-header">
            <h3 id="previewTrackTitle">Cargando...</h3>
            <p id="previewTrackArtist"></p>
        </div>
        
        <div class="preview-player-container" id="previewPlayerContainer">
            <p style="color: #5d7a8c;">Buscando preview...</p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE COMPARTIR SET -->
<!-- ============================================ -->
<div id="shareModal" class="share-modal-container" style="display: none;">
    <div class="share-modal-content">
        <span class="close-share-btn" onclick="closeShareModal()">&times;</span>
        
        <h3>üîó Compartir Set</h3>
        <p>Compart√≠ tu set generado con otros DJs y productores</p>
        
        <div class="share-buttons-grid">
            <button class="btn-share-social" onclick="shareToFacebook()">
                üìò Facebook
            </button>
            <button class="btn-share-social" onclick="shareToTwitter()">
                üê¶ Twitter
            </button>
            <button class="btn-share-social" onclick="shareToWhatsApp()">
                üí¨ WhatsApp
            </button>
            <button class="btn-share-social" onclick="shareToInstagram()">
                üì∑ Instagram
            </button>
            <button class="btn-share-copy" onclick="copyShareLink()">
                üìã Copiar Link
            </button>
        </div>
        
        <div class="share-link-display" id="shareLinkDisplay" onclick="copyShareLink()">
            Generando link...
        </div>
    </div>
</div>
        
<!-- ============================================ -->
<!-- SPOTIFY SEARCH SECTION -->
<!-- ============================================ -->
<div class="spotify-toggle">
    <button class="btn-toggle-spotify" onclick="toggleSpotifySearch()" id="btnToggleSpotify">
        üéµ Buscar en Spotify
    </button>
    <a href="/spotify/login" class="btn-toggle-spotify" style="margin-left: 10px; text-decoration: none;">
        üîó Conectar Spotify
    </a>
</div>

<div id="spotifySearchContainer" class="spotify-search-container" style="display: none;">
    <div class="spotify-search-box">
        <input 
            type="text" 
            id="spotifySearchInput" 
            class="spotify-search-input" 
            placeholder="Buscar artista o canci√≥n en Spotify..."
            onkeyup="handleSpotifySearchKeyup(event)"
        >
        <button class="btn-spotify-search" onclick="searchSpotify()">
            Buscar
        </button>
    </div>
    
    <div id="spotifyResults" class="spotify-results"></div>
</div>

    <div class="filters">
        <button class="btn-warm" onclick="filterEnergy('warm-up')">‚óè Warm-up</button>
        <button class="btn-build" onclick="filterEnergy('building')">‚óè Building</button>
        <button class="btn-mid" onclick="filterEnergy('mid-peak')">‚óè Mid-Peak</button>
        <button class="btn-peak" onclick="filterEnergy('peak time')">‚óè Peak Time</button>
        <button class="btn-drive" onclick="filterEnergy('driving')">‚óè Driving</button>
        <button class="btn-close" onclick="filterEnergy('closing')">‚óè Closing</button>
    </div>

    <div class="search-box">
    <input type="text" id="trackSearch" placeholder="Busca un track..." onkeyup="resetAndSearch()">

    <select id="hoursSelect"
        {% if current_user.role == 'trial' %}
            class="hours-disabled"
            onfocus="this.selectedIndex = 0; alert('Suscripci√≥n PRO requerida para m√°s de 1 hora.'); return false;"
        {% endif %}
    >
        <option value="1">1 hora</option>

        <option value="2" {% if current_user.role == 'trial' %}disabled{% endif %}>2 horas</option>
        <option value="3" {% if current_user.role == 'trial' %}disabled{% endif %}>3 horas</option>
        <option value="4" {% if current_user.role == 'trial' %}disabled{% endif %}>4 horas</option>
        <option value="5" {% if current_user.role == 'trial' %}disabled{% endif %}>5 horas</option>
    </select>

    <button class="btn-generate" onclick="generateSet()">GENERAR SET ARM√ìNICO</button>
</div>


    <div class="track-list">
        <div class="track-header" id="trackHeader">
            <div>#</div><div>Track</div><div>BPM</div><div>Key</div><div>Energy</div>
        </div>
        <div id="results">
            <p style="text-align: center; padding: 20px; color: #5d7a8c;">Los tracks aparecer√°n aqu√≠...</p>
        </div>
        <div id="loading-trigger" style="height: 20px;"></div>
    </div>

<!-- ============================================ -->
<!-- VISUALIZACIONES: GR√ÅFICO Y KEY WHEEL -->
<!-- ============================================ -->
<div id="visualizations" class="visualizations" style="display: none;">
    <!-- Gr√°fico de energ√≠a -->
    <div class="viz-card">
        <h3>üìä Energy Journey</h3>
        <canvas id="energyChart"></canvas>
    </div>

    <!-- Key Wheel -->
    <div class="viz-card">
        <h3>üé® Camelot Wheel</h3>
        <div class="key-wheel" id="keyWheel"></div>
    </div>
</div>

    <div class="export-tools" id="exportTools" style="display: none;">
        <button class="btn-share-set" onclick="shareSet()">üîó Compartir Set</button>
        <button class="btn-export" onclick="exportTXT()">TXT</button>
        <button class="btn-export" onclick="exportCSV()">CSV</button>
        <button class="btn-export" onclick="exportM3U()">M3U</button>
        <button class="btn-export" onclick="exportRekordboxXML()">XML</button>
    </div>

    </div>

<script>
// Variables globales
let selectedEnergy = '';
let currentPage = 1;
let isLoading = false;
let hasMore = true;
let isGenerating = false;
let currentSetlist = []; 
let lockedTracks = []; 
const userRole = "{{ current_user.role if current_user.is_authenticated else 'guest' }}";

function toggleAuthForm(formType) {
    document.getElementById('loginForm').style.display = (formType === 'login') ? 'block' : 'none';
    document.getElementById('signupForm').style.display = (formType === 'signup') ? 'block' : 'none';
}

function showPaymentOptions() {
    document.getElementById('paymentOptions').style.display = 'flex';
    selectPlan('monthly');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert("¬°Direcci√≥n copiada!"));
}

function filterEnergy(energy) {
    selectedEnergy = energy;
    isGenerating = false;
    resetAndSearch();
}

function resetAndSearch() {
    currentPage = 1;
    hasMore = true;
    document.getElementById('results').innerHTML = ''; 
    searchPreview(false, selectedEnergy); 
}

async function searchPreview(append = false, stage = selectedEnergy) {
    if (isLoading || (!hasMore && append)) return;
    isLoading = true;
    
    const query = document.getElementById('trackSearch').value;
    const endpoint = `/api/search?q=${encodeURIComponent(query)}&page=${currentPage}&energy=${encodeURIComponent(stage)}`;

    try {
        const res = await fetch(endpoint);
        const data = await res.json();
        renderList(data.tracks, false, append);
        hasMore = data.has_more;
        isLoading = false;
    } catch (e) {
        console.error("Error:", e);
        isLoading = false;
    }
}

window.onscroll = function() {
    if (isGenerating) return;
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 800) {
        if (!isLoading && hasMore) {
            currentPage++;
            searchPreview(true); 
        }
    }
};

function selectTrackForStart(artist, track) {
    document.getElementById('trackSearch').value = artist + " - " + track;
    resetAndSearch();
}

async function generateSet() {
    isGenerating = true;
    const startTrack = document.getElementById('trackSearch').value;
    const hours = document.getElementById('hoursSelect').value;
    const container = document.getElementById('results');
    
    container.innerHTML = '<p style="text-align:center; padding: 20px;">Generando set inteligente...</p>';

    let endpoint = '/generate';
    let bodyData = { start_track: startTrack, hours: hours };

    const hasLockedTracks = currentSetlist.length > 0 && lockedTracks.some(locked => locked === true);

    if (hasLockedTracks) {
        endpoint = '/api/generate_locked';
        bodyData.locked_setlist = currentSetlist.map((track, index) => {
            const trackCopy = {...track}; 
            if (lockedTracks[index]) trackCopy.isLocked = true;
            return trackCopy;
        });
    }
    
    try {
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(bodyData)
        });

        if (res.status === 403) {
            const errorData = await res.json();
            alert(errorData.error);
            isGenerating = false;
            return;
        }

        const data = await res.json();
        
        currentSetlist = data;
        lockedTracks = new Array(data.length).fill(false);
        
        renderList(data, true, false);
        document.getElementById('exportTools').style.display = 'flex';
        renderVisualizations();
    } catch (e) {
        container.innerHTML = '<p style="text-align:center; padding: 20px;">Error al generar.</p>';
    }
    
    isGenerating = false;
}

function getEnergyStyle(energy) {
    if (!energy) return 'color: #fff; border-color: #fff;';
    const e = energy.toLowerCase();
    if (e.includes('warm')) return 'color: var(--warm); border-color: var(--warm)';
    if (e.includes('build')) return 'color: var(--build); border-color: var(--build)';
    if (e.includes('mid')) return 'color: var(--mid); border-color: var(--mid)';
    if (e.includes('peak')) return 'color: var(--peak); border-color: var(--peak)';
    if (e.includes('driv')) return 'color: var(--driving); border-color: var(--driving)';
    if (e.includes('clos')) return 'color: var(--closing); border-color: var(--closing)';
    return 'color: #fff; border-color: #fff;';
}

function renderList(tracks, isFullSet = false, append = false) {
    const container = document.getElementById('results');
    const header = document.getElementById('trackHeader');
    
    if (!append) container.innerHTML = '';
    
    if (!tracks || tracks.length === 0) {
        if (!append) container.innerHTML = '<p style="text-align:center; padding: 20px;">No hay resultados.</p>';
        return;
    }

    if (isFullSet) {
    header.classList.add('has-actions');
    header.innerHTML = '<div>#</div><div></div><div>Track</div><div>BPM</div><div>Key</div><div>Energy</div><div>Acci√≥n</div>';
} else {
    header.classList.remove('has-actions');
    header.innerHTML = '<div>#</div><div>Track</div><div>BPM</div><div>Key</div><div>Energy</div>';
}

    const html = tracks.map((t, i) => {
        const indexShow = isFullSet ? (i + 1) : "";
        const stageLabel = t.stage || t.energy || "Track";
        const lockIcon = lockedTracks[i] ? 'üîí' : 'üîì';
        const lockHtml = isFullSet ? `<div class="col-lock ${lockedTracks[i]?'locked':''}" onclick="lockTrack(${i})">${lockIcon}</div>` : '';
        const actionButtonHtml = isFullSet ? `<div class="col-actions"><button onclick="changeTrack(${i})">Cambiar</button></div>` : '';
        const previewButtonHtml = '';
        const clickAttr = !isFullSet ? `onclick="selectTrackForStart('${(t.artist||'').replace(/'/g,"\\'")}', '${(t.track||'').replace(/'/g,"\\'")}')"` : '';

        return `
            <div class="track-item ${!isFullSet ? 'selectable' : ''} ${isFullSet ? 'has-actions' : ''}" ${clickAttr} id="trackItem${i}">
                <div class="col-num">${indexShow}</div>
                ${lockHtml}
                <div class="col-track">${t.artist} - ${t.track}</div>
                <div class="col-bpm">${t.bpm}</div>
                <div class="col-key">${t.key}</div>
                <div><span class="energy-badge" style="${getEnergyStyle(stageLabel)}">${stageLabel}</span></div>
                ${actionButtonHtml}
                ${previewButtonHtml}
            </div>
        `;
    }).join('');

    if (append) {
        container.insertAdjacentHTML('beforeend', html);
    } else {
        container.innerHTML = html;
    }
}

function downloadFile(content, fileName, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName; a.click();
}

function exportTXT() {
    const content = currentSetlist.map(t => `${t.artist} - ${t.track} | ${t.bpm} | ${t.key}`).join('\n');
    downloadFile(content, 'setlist.txt', 'text/plain');
}

function exportCSV() {
    const header = "Artist,Track,BPM,Key\n";
    const rows = currentSetlist.map(t => `"${t.artist}","${t.track}",${t.bpm},${t.key}`).join('\n');
    downloadFile(header + rows, 'setlist.csv', 'text/csv');
}

function exportM3U() {
    const content = "#EXTM3U\n" + currentSetlist.map(t => `${t.artist} - ${t.track}.mp3`).join('\n');
    downloadFile(content, 'setlist.m3u', 'audio/x-mpegurl');
}

function exportRekordboxXML() {
    let xml = `<?xml version="1.0" encoding="UTF-8"?><DJ_PLAYLISTS Version="1.0"><COLLECTION TotalTrackCount="${currentSetlist.length}">`;
    currentSetlist.forEach((t, i) => {
        xml += `<TRACK TrackID="${i+1}" Artist="${t.artist}" Title="${t.track}" BPM="${t.bpm}" Key="${t.key}" />`;
    });
    xml += `</COLLECTION></DJ_PLAYLISTS>`;
    downloadFile(xml, 'setlist.xml', 'text/xml');
}

function lockTrack(index) {
    if (index === 0) return;
    lockedTracks[index] = !lockedTracks[index];
    renderList(currentSetlist, true, false);
}

async function changeTrack(index) {
    if (index === 0 || lockedTracks[index]) return;
    try {
        const res = await fetch(`/api/change_track/${index}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ current_setlist: currentSetlist })
        });
        if (res.ok) {
            const newTrack = await res.json();
            currentSetlist[index] = newTrack;
            renderList(currentSetlist, true, false); 
        }
    } catch (e) { console.error(e); }
}

let selectedPlan = 'monthly';

function selectPlan(plan) {
    selectedPlan = plan;
    document.getElementById('btnMonthly').classList.toggle('active', plan === 'monthly');
    document.getElementById('btnAnnual').classList.toggle('active', plan === 'annual');
}

function closePaymentModal() {
    document.getElementById('paymentOptions').style.display = 'none';
}

function closeCryptoModal() {
    document.getElementById('cryptoPaymentModal').style.display = 'none';
}

function showCryptoPayment() {
    const amount = selectedPlan === 'monthly' ? '10 USDT' : '45 USDT';
    const planName = selectedPlan === 'monthly' ? 'Mensual' : 'Anual';
    
    document.getElementById('cryptoAmount').textContent = amount;
    document.getElementById('cryptoPlan').textContent = planName;
    
    document.getElementById('paymentOptions').style.display = 'none';
    document.getElementById('cryptoPaymentModal').style.display = 'flex';
}

async function submitCryptoPayment(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('paymentScreenshot');
    const txId = document.getElementById('txId').value;
    
    if (!fileInput.files[0]) {
        alert('Por favor seleccion√° una captura de pantalla.');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        const base64Image = e.target.result;
        
        try {
            const res = await fetch('/api/submit_crypto_payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    plan: selectedPlan,
                    tx_id: txId,
                    screenshot: base64Image
                })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                alert('‚úÖ Comprobante enviado correctamente. Tu cuenta ser√° activada en 24hs h√°biles.');
                closeCryptoModal();
                document.getElementById('cryptoPaymentForm').reset();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Hubo un error al enviar el comprobante. Intenta de nuevo.');
        }
    };
    
    reader.readAsDataURL(file);
}

async function handleMercadoPago() {
    try {
        const res = await fetch('/create-payment', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ type: selectedPlan })
        });
        if (!res.ok) return;
        const data = await res.json();
        const mp = new MercadoPago('APP_USR-7eac6494-286c-4d75-8b99-117df00b0220', { locale: 'es-AR' });
        document.querySelectorAll('.btn-mercadopago').forEach(btn => btn.style.display = 'none');
        mp.checkout({ preference: { id: data.preference_id }, render: { container: '#payment-widget-container', label: 'Pagar' } });
    } catch (e) { console.error(e); }
}

let currentShareUrl = '';

async function shareSet() {
    if (!currentSetlist || currentSetlist.length === 0) {
        alert('Primero debes generar un set para compartirlo.');
        return;
    }
    
    // Primero obtenemos referencias a los elementos
    const modal = document.getElementById('shareModal');
    const linkDisplay = document.getElementById('shareLinkDisplay');
    
    // Verificamos que existan
    if (!modal || !linkDisplay) {
        console.error('Modal de compartir no encontrado en el DOM');
        alert('Error: No se pudo abrir el modal de compartir.');
        return;
    }
    
    const hours = document.getElementById('hoursSelect').value;
    
    // Ahora s√≠ mostramos el modal
    modal.style.display = 'flex';
    linkDisplay.textContent = 'Generando link √∫nico...';
    
    try {
        const res = await fetch('/api/share_set', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ setlist: currentSetlist, hours: parseInt(hours) })
        });
        
        if (!res.ok) throw new Error('Error al generar link');
        
        const data = await res.json();
        currentShareUrl = data.share_url;
        linkDisplay.textContent = currentShareUrl;
    } catch (e) {
        console.error('Error:', e);
        alert('Hubo un error al generar el link. Intenta de nuevo.');
        closeShareModal();
    }
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
}

function shareToFacebook() {
    const url = encodeURIComponent(currentShareUrl);
    const text = encodeURIComponent('üéß Check out this Progressive House set I generated with AI!');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
}

function shareToTwitter() {
    const url = encodeURIComponent(currentShareUrl);
    const text = encodeURIComponent('üéß Just generated an epic Progressive House set with AI! Check it out:');
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function shareToInstagram() {
    copyShareLink();
    alert('üì∑ Link copiado! Ahora puedes pegarlo en tu Instagram Story o Bio.');
}

function shareToWhatsApp() {
    const url = encodeURIComponent(currentShareUrl);
    const text = encodeURIComponent('üéß Mira este set de Progressive House que gener√© con AI: ');
    window.open(`https://wa.me/?text=${text}${url}`, '_blank');
}

function copyShareLink() {
    navigator.clipboard.writeText(currentShareUrl).then(() => {
        const display = document.getElementById('shareLinkDisplay');
        const originalText = display.textContent;
        display.textContent = '‚úÖ Link copiado al portapapeles!';
        display.style.background = 'rgba(0, 255, 140, 0.2)';
        setTimeout(() => {
            display.textContent = originalText;
            display.style.background = '#000';
        }, 2000);
    });
}

function toggleSpotifySearch() {
    const container = document.getElementById('spotifySearchContainer');
    const btn = document.querySelector('.btn-toggle-spotify');
    if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.classList.add('active');
    } else {
        container.style.display = 'none';
        btn.classList.remove('active');
    }
}

function handleSpotifySearchKeyup(event) {
    if (event.key === 'Enter') searchSpotify();
}

async function searchSpotify() {
    const query = document.getElementById('spotifySearchInput').value.trim();
    const resultsContainer = document.getElementById('spotifyResults');
    
    if (!query) {
        resultsContainer.innerHTML = '';
        return;
    }
    
    resultsContainer.innerHTML = '<p class="spotify-no-results">Buscando en Spotify...</p>';
    
    try {
        const res = await fetch(`/api/spotify/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        if (res.status === 401) {
            resultsContainer.innerHTML = `<p class="spotify-no-results">‚ö†Ô∏è ${data.message}<br><a href="/spotify/login" style="color: #1DB954;">Click ac√° para conectar tu cuenta</a></p>`;
            return;
        }
        
        if (!data.tracks || data.tracks.length === 0) {
            resultsContainer.innerHTML = '<p class="spotify-no-results">No se encontraron resultados.</p>';
            return;
        }
        
        renderSpotifyResults(data.tracks);
    } catch (error) {
        console.error('Error searching Spotify:', error);
        resultsContainer.innerHTML = '<p class="spotify-no-results">Error al buscar. Intenta de nuevo.</p>';
    }
}

function renderSpotifyResults(tracks) {
    const resultsContainer = document.getElementById('spotifyResults');
    const html = tracks.map((track, idx) => {
        const trackDataStr = JSON.stringify(track).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const previewUrl = track.preview_url || '';
        return `
        <div class="spotify-track-item">
            <img src="${track.image || '/static/default-album.png'}" alt="${track.track}" class="spotify-album-art">
            <div class="spotify-track-info">
                <div class="spotify-track-name">${track.track}</div>
                <div class="spotify-artist-name">${track.artist}</div>
                <div class="spotify-track-meta">
                    ${track.bpm ? `<span>üéµ ${track.bpm} BPM</span>` : ''}
                    ${track.key ? `<span>üéπ ${track.key}</span>` : ''}
                    ${track.energy ? `<span>‚ö° Energy: ${track.energy}/10</span>` : ''}
                </div>
            </div>
            <div>
                <button class="spotify-preview-btn" data-preview="${previewUrl}" data-spotify-id="${track.spotify_id}" onclick="playSpotifySearchPreview(this)" id="search-preview-${idx}">‚ñ∂Ô∏è Play</button>
            </div>
            <div>
                <button class="btn-add-spotify-track" data-track='${trackDataStr}' onclick="addSpotifyTrackToSetFixed(this)">‚ûï Agregar</button>
            </div>
        </div>`;
    }).join('');
    resultsContainer.innerHTML = html;
}

let currentSearchAudio = null;

function playSpotifySearchPreview(button) {
    const spotifyId = button.getAttribute('data-spotify-id');
    const previewUrl = button.getAttribute('data-preview');
    
    // Si clickeamos el mismo bot√≥n que ya est√° abierto, cerrar el player
    const existingPlayer = button.closest('.spotify-track-item').querySelector('.spotify-inline-player');
    if (existingPlayer) {
        existingPlayer.remove();
        button.textContent = '‚ñ∂Ô∏è Play';
        button.classList.remove('playing');
        return;
    }
    
    // Cerrar cualquier otro player abierto
    document.querySelectorAll('.spotify-inline-player').forEach(player => player.remove());
    document.querySelectorAll('.spotify-preview-btn').forEach(btn => {
        btn.textContent = '‚ñ∂Ô∏è Play';
        btn.classList.remove('playing');
    });
    
    // Crear el reproductor embebido de Spotify
    const playerContainer = document.createElement('div');
    playerContainer.className = 'spotify-inline-player';
    playerContainer.innerHTML = `
        <iframe 
            style="border-radius:12px; margin-top: 10px;" 
            src="https://open.spotify.com/embed/track/${spotifyId}?utm_source=generator&theme=0" 
            width="100%" 
            height="152" 
            frameBorder="0" 
            allowfullscreen="" 
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
            loading="lazy">
        </iframe>
    `;
    
    // Insertar el reproductor debajo del track
    const trackItem = button.closest('.spotify-track-item');
    trackItem.appendChild(playerContainer);
    
    // Cambiar el bot√≥n a "Cerrar"
    button.textContent = '‚úñÔ∏è Cerrar';
    button.classList.add('playing');
}

function addSpotifyTrackToSetFixed(button) {
    const trackDataStr = button.getAttribute('data-track');
    const track = JSON.parse(trackDataStr.replace(/&quot;/g, '"'));
    let stage = 'warmup';
    if (track.bpm && track.energy) {
        if (track.bpm < 120 && track.energy < 5) stage = 'warmup';
        else if (track.bpm >= 120 && track.bpm < 123 && track.energy >= 4 && track.energy < 7) stage = 'build';
        else if (track.bpm >= 121 && track.bpm < 124 && track.energy >= 6 && track.energy < 9) stage = 'mid_peak';
        else if (track.bpm >= 123 && track.bpm < 125 && track.energy >= 7) stage = 'peak_time';
        else if (track.bpm >= 124 && track.energy >= 8) stage = 'driving';
        else if (track.bpm >= 120 && track.bpm < 125 && track.energy >= 4 && track.energy < 8) stage = 'closing';
    }
    const newTrack = {
        artist: track.artist, track: track.track, bpm: track.bpm || 120,
        key: track.key || '8A', energy: track.energy || 5, stage: stage, spotify_id: track.spotify_id
    };
    currentSetlist.push(newTrack);
    lockedTracks.push(false);
    renderList(currentSetlist, true, false);
    document.getElementById('exportTools').style.display = 'flex';
    alert(`‚úÖ "${track.track}" agregado al set!`);
}

async function playPreview(index) {
    const track = currentSetlist[index];
    document.getElementById('previewModal').style.display = 'flex';
    document.getElementById('previewTrackTitle').textContent = track.track;
    document.getElementById('previewTrackArtist').textContent = track.artist;
    document.getElementById('previewPlayerContainer').innerHTML = '<p style="color: #5d7a8c;">Buscando preview...</p>';
    if (track.spotify_id) {
        showSpotifyEmbed(track.spotify_id);
        return;

    }
    try {
        const res = await fetch('/api/get_preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ artist: track.artist, track: track.track })
        });
        if (!res.ok) {
            document.getElementById('previewPlayerContainer').innerHTML = '<p style="color: #ff0040;">‚ùå No se encontr√≥ preview para este track</p>';
            return;
        }
        const data = await res.json();
       if (data.type === 'spotify') {
    currentSetlist[index].spotify_id = data.id;
    showSpotifyEmbed(data.id);
} else {
    document.getElementById('previewPlayerContainer').innerHTML = '<p style="color: #ff0040;">‚ùå Solo se pueden reproducir previews de Spotify</p>';
}
    } catch (error) {
        console.error('Error fetching preview:', error);
        document.getElementById('previewPlayerContainer').innerHTML = '<p style="color: #ff0040;">‚ùå Error al buscar preview</p>';
    }
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
    document.getElementById('previewPlayerContainer').innerHTML = '';
}

let energyChart = null;

function renderVisualizations() {
    document.getElementById('visualizations').style.display = 'grid';
    renderEnergyChart();
    renderKeyWheel();
}

function renderEnergyChart() {
    const energyMap = { warmup: 3, build: 5, mid_peak: 7, midpeaks: 7, peak_time: 9, peaktime: 9, driving: 10, closing: 6 };
    const labels = currentSetlist.map((_, i) => `#${i + 1}`);
    const data = currentSetlist.map(t => energyMap[(t.stage || '').toLowerCase()] || 5);
    const ctx = document.getElementById('energyChart').getContext('2d');
    if (energyChart) energyChart.destroy();
    energyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Energy Level', data: data, borderColor: '#00ff8c', backgroundColor: 'rgba(0, 255, 136, 0.1)',
                borderWidth: 3, fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7,
                pointBackgroundColor: '#00ff8c', pointBorderColor: '#fff', pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { backgroundColor: 'rgba(0, 26, 38, 0.95)', titleColor: '#00ff8c', bodyColor: '#fff', borderColor: '#00f2ff', borderWidth: 2, padding: 12, displayColors: false }
            },
            scales: {
                y: { beginAtZero: true, max: 10, ticks: { color: '#00d4ff', font: { size: 12, weight: 'bold' }}, grid: { color: 'rgba(0, 242, 255, 0.1)' }},
                x: { ticks: { color: '#00ff8c', font: { size: 11 }}, grid: { color: 'rgba(0, 255, 140, 0.1)' }}
            }
        }
    });
}

function renderKeyWheel() {
    const wheel = document.getElementById('keyWheel');
    wheel.innerHTML = '';
    const keysA = ["12A", "1A", "2A", "3A", "4A", "5A", "6A", "7A", "8A", "9A", "10A", "11A"];
    const keysB = ["12B", "1B", "2B", "3B", "4B", "5B", "6B", "7B", "8B", "9B", "10B", "11B"];
    const allKeys = [...keysA, ...keysB];
    const usedKeys = currentSetlist.map(t => t.key);
    const keyCounts = {};
    usedKeys.forEach(k => keyCounts[k] = (keyCounts[k] || 0) + 1);
    const centerX = 150, centerY = 150;
    allKeys.forEach((key, index) => {
        const isB = key.endsWith('B');
        const radius = isB ? 120 : 85; // Keys B m√°s afuera
        const keyNumber = parseInt(key.match(/\d+/)[0]);
        const adjustedIndex = keyNumber - 1; // Usar el n√∫mero de la key como √≠ndice
        const angle = (adjustedIndex / 12) * 2 * Math.PI - Math.PI / 2;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        const btn = document.createElement('div');
        btn.className = 'key-button';
        btn.textContent = key;
        btn.style.left = `${x - 17.5}px`;
        btn.style.top = `${y - 17.5}px`;
        if (keyCounts[key]) {
            btn.classList.add('active');
            if (keyCounts[key] > 2) btn.classList.add('used-multiple');
            btn.title = `Usado ${keyCounts[key]} ${keyCounts[key] === 1 ? 'vez' : 'veces'}`;
        }
        wheel.appendChild(btn);
    });
}
</script>
</body>

</html>

